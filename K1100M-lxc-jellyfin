# Remember that host and guest driver have to be in sync!

# https://theorangeone.net/posts/lxc-nvidia-gpu-passthrough/

apt update
apt upgrade -y
apt install gcc make -y

# K1100M specific

wget https://us.download.nvidia.com/XFree86/Linux-x86_64/470.161.03/NVIDIA-Linux-x86_64-470.161.03.run

# Disable nouveau driver, just copying exactly what the Nvidia installer would make
cat << EOF >> /etc/modprobe.d/nvidia-installer-disable-nouveau.conf
# generated by nvidia-installer
blacklist nouveau
options nouveau modeset=0
EOF

reboot now

sh NVIDIA-Linux-x86_64-470.161.03.run --no-kernel-module # Use default options

# Jellyfin

apt install curl gnupg
mkdir /etc/apt/keyrings
curl -fsSL https://repo.jellyfin.org/$( awk -F'=' '/^ID=/{ print $NF }' /etc/os-release )/jellyfin_team.gpg.key | gpg --dearmor -o /etc/apt/keyrings/jellyfin.gpg

cat <<EOF >> /etc/apt/sources.list.d/jellyfin.sources
Types: deb
URIs: https://repo.jellyfin.org/$( awk -F'=' '/^ID=/{ print $NF }' /etc/os-release )
Suites: $( awk -F'=' '/^VERSION_CODENAME=/{ print $NF }' /etc/os-release )
Components: main
Architectures: $( dpkg --print-architecture )
Signed-By: /etc/apt/keyrings/jellyfin.gpg
EOF

apt update
apt install jellyfin
